FROM tfm/pf_ring

# version=5.0.2
ARG SURICATA_VERSION=5.0.2

# Include dist
ADD dist/ /root/dist/

# Pre-installation requirements
RUN apt-get update && \
    apt-get upgrade -y \
    && apt-get -y install libpcre3 libpcre3-dbg libpcre3-dev \
        build-essential autoconf automake libtool libpcap-dev libnet1-dev \
        libyaml-0-2 libyaml-dev zlib1g zlib1g-dev libcap-ng-dev libcap-ng0 \
        make libmagic-dev libjansson-dev libjansson4 pkg-config \
        python-yaml wget git flex bison libnspr4-dev libnss3-dev liblz4-dev \
        rustc cargo libgeoip1 libgeoip-dev oinkmaster libhtp-dev libluajit-5.1-dev \
        # Libraries required to run Suricata in IPS mode.
        libnetfilter-queue-dev libnetfilter-queue1 libnfnetlink-dev libnfnetlink0 \
        libmaxminddb-dev libhiredis-dev

# Install suricata
RUN wget -LO suricata.tar.gz "http://www.openinfosecfoundation.org/download/suricata-$SURICATA_VERSION.tar.gz" && \
    tar -xvzf "suricata.tar.gz" && \
    rm suricata.tar.gz && \
    cd "suricata-$SURICATA_VERSION" && \
    ./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
	    --mandir=/usr/share/man \
	    # --enable-non-bundled-htp \
        --enable-nfqueue \
            --enable-rust \
        -disable-gccmarch-native \
        --enable-hiredis \
        --enable-geoip \
        --enable-gccprotect \
        --enable-pie \
        --enable-luajit \
        --enable-pfring \
            --with-libpfring-includes=/opt/pfring/include \
            --with-libpfring-libraries=/opt/pfring/lib \
            --with-libpcap-includes=/opt/pf_ring/include \
            --with-libpcap-libraries=/opt/pf_ring/lib && \
    make && \
    make check && \
    make install && \
    make install-full && \
    ldconfig

#
# Setup user, groups and configs
# RUN addgroup -g 2000 suri && \
#     adduser -S -H -u 2000 -D -g 2000 suri && \
#     chmod 644 /etc/suricata/*.config && \
#     cp /root/dist/suricata.yaml /etc/suricata/suricata.yaml && \
#     cp /root/dist/*.bpf /etc/suricata/ && \
#     mkdir -p /etc/suricata/rules

# CMD [""]